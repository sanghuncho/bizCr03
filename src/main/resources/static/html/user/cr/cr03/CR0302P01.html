<style>
.popup_bottom_btn {
	bottom: 25px;
}

.columnSideBySide {
  /* float: left;
  padding: 5px;
  width: 50%; */
  flex: 50%;
}

.rowSideBySide {
/*.rowSideBySide::after {
   content: "";
  clear: both;
  display: table; */
  display: flex;
}
</style>
<!-- <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css"/>
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css"/>
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css"/>
    <link rel="stylesheet" href="/static/css/ax5/ax5toast.css"/>
    <link rel="stylesheet" href="/static/css/jstree/style.min.css"/>
    <link rel="stylesheet" href="/static/css/gnb.css"/>
    <link rel="stylesheet" href="/static/css/main.css"/>
    	<link rel="stylesheet" href="/static/css/sub.css" />
    <link rel="stylesheet" href="/static/css/common.css"/>

    <link rel="stylesheet" href="/static/css/sub.css"/>

    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/ax5ui/ax5ui-calendar/master/dist/ax5calendar.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/ax5ui/ax5ui-picker/master/dist/ax5picker.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/ax5ui/ax5ui-select/master/dist/ax5select.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5menu.css">

   <script src="/static/js/jquery-latest.min.js"></script>
   <script src="/static/js/jquery.serializeObject.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
     <script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script src="/static/js/moment/moment-with-locales.js"></script>
    <script src="/static/js/ax5/ax5core.min.js"></script>
    <script src="/static/js/ax5/ax5calendar.min.js"></script> 
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-picker/master/dist/ax5picker.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-formatter/master/dist/ax5formatter.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/ax5ui/ax5ui-select/master/dist/ax5select.min.js"></script>
    <script src="/static/js/ax5/ax5grid.min.js"></script>
    <script src="/static/js/ax5/ax5mask.min.js"></script>
    <script src="/static/js/ax5/ax5modal.min.js"></script>
    <script src="/static/js/ax5/ax5toast.min.js"></script>
    <script src="/static/js/jstree/jstree.min.js"></script>
    <script src="/static/js/ax5/ax5menu.min.js"></script>
    <script type="text/javascript" src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="/static/js/global.js"></script>
    <script src="/static/js/fileTree.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
   
    <style>

    </style>

</head> -->
<div class="popup_area of_a" style=" height: 100%;">
    <div id="first-focus" class="tit_contents">
        <h4 class="tit">구매BOM</h4>
    </div>
    <div class="toggle-div" style="padding-left: 0;">
        <div class="popup_table">

            <form id="popForm">
                <input type="hidden" id="pgmId" name="pgmId" value="CR0101M01">
                <table>
                    <tr>
                        <th class="hit">회사</th>
	                    <td>
	                        <select id="coCd_S_Org" style="width:100%;" data-kind="CO" onchange="updateTopLeftTableData();"
	                                required="required">
	                            <option value="">전체</option>
	                            <option value="10">건양ITT</option>
	                        </select>
	                    </td>
                        <th class="hit">Sales Code</th>
	                    <td>
	                        <input type="hidden" id="salesCd_S" name="salesCd_S">
	                        <div class="search_form">
	                            <input type="text" id="salesCdNm_S" name="salesCdNm_S">
	                            <a onclick="opendSalesCdSearch($('#salesCdNm_S').val());">
	                                <i class="i_search_w"></i>
	                            </a>
	                        </div>
	                    </td>
                        <th class="hit">회사</th>
	                    <td>
	                        <select id="coCd_S" style="width:100%;" data-kind="CO" onchange="gridView.setData(0);"
	                                required="required">
	                            <option value="">전체</option>
	                            <option value="10">건양ITT</option>
	                        </select>
	                    </td>
                        <th class="hit">Sales Code</th>
	                    <td>
	                        <input type="hidden" id="salesCd_S" name="salesCd_S">
	                        <div class="search_form">
	                            <input type="text" id="salesCdNm_S" name="salesCdNm_S">
	                            <a onclick="opendSalesCdSearch($('#salesCdNm_S').val());">
	                                <i class="i_search_w"></i>
	                            </a>
	                        </div>
	                    </td>
                    </tr>
                    <tr>
                        <th class="">고객사</th>
	                    <td>
	                        <input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S">
	                        <div class="search_form">
	                            <input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S"
	                                   >
	                            <a onclick="opendClntSearch($('#ordrsClntNm_S').val());">
	                                <i class="i_search_w"></i>
	                            </a>
	                        </div>
	                    </td>
                        <th class="">고객사 PJT</th>
	                    <td>
	                        <div class="search_form">
	                            <input type="text" id="clntPjt_S" name="clntPjt_S" class="modal-clntPjt_S">
	                        </div>
                    	</td>
                    	
                        <th class="">고객사</th>
	                    <td>
	                        <input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S">
	                        <div class="search_form">
	                            <input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S"
	                                   >
	                            <a onclick="opendClntSearch($('#ordrsClntNm_S').val());">
	                                <i class="i_search_w"></i>
	                            </a>
	                        </div>
	                    </td>
                        <th class="">고객사 PJT</th>
	                    <td>
	                        <div class="search_form">
	                            <input type="text" id="clntPjt_S" name="clntPjt_S" class="modal-clntPjt_S">
	                        </div>
                    	</td>
                    </tr>
                    <tr>
                        <th class="">설비명</th>
	                    <td colspan="1">
	                        <div class="search_form">
	                            <input type="text" id="eqpNm_S" name="eqpNm_S" class="modal-eqpNm_S">
	                        </div>
	                    </td>
	                    <th colspan="2"></th>
	                    
                        <th class="">설비명</th>
	                    <td colspan="1">
	                        <div class="search_form">
	                            <input type="text" id="eqpNm_S" name="eqpNm_S" class="modal-eqpNm_S">
	                        </div>
	                    </td>
	                    <th colspan="2"></th>
                    </tr>
                    <tr>
                        <th class="">제품구분</th>
	                    <td>
							<select id="itemList_S" style="width:100%;" data-kind="ITEMLIST" onchange="gridView.setData(0);"
	                                required="required">
	                            <option value="">선택</option>
	                        </select>
						</td>
                        <th class="">아이템구분</th>
	                    <td>
	                        <select id="itemList_S" style="width:100%;" data-kind="ITEMLIST" onchange="gridView.setData(0);"
	                                required="required">
	                            <option value="">선택</option>
	                        </select>
	                    </td>
                        <th class="">제품구분</th>
	                    <td>
							<select id="itemList_S" style="width:100%;" data-kind="ITEMLIST" onchange="gridView.setData(0);"
	                                required="required">
	                            <option value="">선택</option>
	                        </select>
						</td>
                        <th class="">아이템구분</th>
	                    <td>
	                        <select id="itemList_S" style="width:100%;" data-kind="ITEMLIST" onchange="gridView.setData(0);"
	                                required="required">
	                            <option value="">선택</option>
	                        </select>
	                    </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    <br>
    <div class="popup_table" style="">
        <div class="toggle-div" style="padding-left: 0;">
            <div class="" style="padding-left: 0;">
                <div id="est_grid" class="contents"
                     style="margin:0px; padding:0px; height: 380px; width: 100%; min-width: 200px;border-radius:0;">
                    <h3 class="location">
                        <a class="file_tag" id="file_tag"
                           style="font-weight:bold ; color: blue; padding-left: 20px;padding-right: 10px;"></a>
                        <span class="page_tit" style="text-align: right;"></span>
                    </h3>
                    <div class="rowSideBySide">
	                    <div class="columnSideBySide">
					        <div class="contents_tit">
					            <div>
					                <div class="add_btn_small pdl10" style="margin-right:8px;">
					                    <a onclick="insertProjectModal('C')" style="height: 30px; line-height: 28px;" authchk>+</a>
					                    <a onclick="deleteEst()" style="height: 30px; line-height: 28px;" authchk>-</a>
					                </div>
					            </div>
					        </div>
		                    <div class="contents" style="margin:0px;padding:0 5px;height:80%;min-width:300px">
		                        <div data-ax5grid="top-left-grid" data-ax5grid-config="{}" style="height: 300px;"></div>
		                    </div>
		                </div>
		                <div class="columnSideBySide">
		                	<!-- 콘텐츠 타이틀 -->
					        <div class="contents_tit">
					            <div>
					                <div class="add_btn_small pdl10" style="margin-right:8px;">
					                    <a onclick="insertProjectModal('C')" style="height: 30px; line-height: 28px;" authchk>+</a>
					                    <a onclick="deleteEst()" style="height: 30px; line-height: 28px;" authchk>-</a>
					                </div>
					            </div>
					        </div>
		                    <div class="contents" style="margin:0px;padding:0 5px;height:80%;min-width:300px">
		                        <div data-ax5grid="top-right-grid" data-ax5grid-config="{}" style="height: 300px;"></div>
		                    </div>
		                </div>
		            </div>
		             <!-- 첨부파일 -->
		            <!-- <div class="toggle-div" style="padding-left: 0;margin-bottom:40px;">
				        <div class="row" style="margin-top: 15px;margin-right:0px;margin-left:0px;">
				            <div class="col-xs-2" style="padding-right: 5px;">
				                <div class="contents"
				                     style="margin: 0; padding: 0;width: 100%; min-width: 200px;height:380px;border-radius: 0">
				
				                    <div id="treeview" style="padding: 5px">
				                        <div style="text-align: center;" class="location">
				                            <span class="page_tit"> 파일트리</span>
				                        </div>
				                        <div id="deptTree"></div>
				                    </div>
				                </div>
				            </div>
				
				            <div class="col-xs-10" style="padding-left: 0;">
				                <div class="contents"
				                     style="margin: 0; padding: 0;   width: 100%; min-width: 200px;height:380px;border-radius:0;text-align:center">
				                    <h3 class="location">
				                        <a class="file_tag" id="file_tag"
				                           style="font-weight: bold; color: blue; padding-left: 20px; padding-right: 10px;"></a>
				                        <span class="page_tit" id="file_tit" style="text-align: right;"> 문서현황</span>
				                    </h3>
				
				                    <button disabled type="button" id="button_file" class=""
				                            style="  background-color: gray;height: 25px; line-height: 15px;" onclick="file.click();"
				                            authchk>
				                        	첨부파일
				                    </button>
				                              <button  type="button" id="zip_down" class=""
				                                       style="display:none;height: 25px; line-height: 15px;"
				                                       authchk>
				                                   파일 전체 다운로드
				                               </button>
				                    <div class="ax5_grid" data-ax5grid="file-grid-popup" data-ax5grid-config="{}"
				                         style="height: 300px; width: 95%;margin: auto;"></div>
				                </div>
				            </div>
				        </div>
				    </div> -->
				    <!-- 첨부파일 end -->
				    <!--  구매, 자제정보 -->
				    <!-- <div class="rowSideBySide">
	                    <div class="columnSideBySide">
					        <div class="contents_tit">
					            <div>
					                <div class="add_btn_small pdl10" style="margin-right:8px;">
					                    <a onclick="insertProjectModal('C')" style="height: 30px; line-height: 28px;" authchk>+</a>
					                    <a onclick="deleteEst()" style="height: 30px; line-height: 28px;" authchk>-</a>
					                </div>
					            </div>
					        </div>
		                    <div class="contents" style="margin:0px;padding:0 5px;height:80%;min-width:200px">
		                        <div data-ax5grid="bottom-left-grid" data-ax5grid-config="{}" style="height:300px;"></div>
		                    </div>
		                </div>
		                <div class="columnSideBySide">
					        <div class="contents_tit">
					            <div>
					                <div class="add_btn_small pdl10" style="margin-right:8px;">
					                    <a onclick="insertProjectModal('C')" style="height: 30px; line-height: 28px;" authchk>+</a>
					                    <a onclick="deleteEst()" style="height: 30px; line-height: 28px;" authchk>-</a>
					                </div>
					            </div>
					        </div>
		                    <div class="contents" style="margin:0px;padding:0 5px 100px;height:80%;min-width:300px;">
		                        <div data-ax5grid="bottom-right-grid" data-ax5grid-config="{}" style="height:300px;"></div>
		                    </div>
		                </div>
		            </div> -->
		            <!-- 구매, 자제정보 end -->
                </div>
            </div>
        </div>
    </div>
    <br>
   
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
        <button id="actionBtn" authchk>등록</button>
        <button class="close_btn" onclick="modalStack.close();">닫기</button>
    </div>
</div>

<script type="text/javascript">

    /* 견적서함수 */
    //견적 번호 조회 함수
    function getMaxEstNumber() {
        let paramObj = {}; // Add any parameters needed for the request
        // postAjax("/user/cr/cr01/maxEst", paramObj, null, function (data) {
        // 	// Set the received maximum estimation number to the input field
        // 	$("#estNo").val(data.maxEstNo);
        // });
    }

    // 견적 정보 조회 함수
    function selectEstInfo() {
        var paramObj = modalStack.last().paramObj;
        postAjax("/user/cr/cr01/selectEstInfo", paramObj, null, function (data) {
            setEstInfo(data.estInfo);
        });
    }

    // 견적 정보 설정 함수
    function setEstInfo(estInfo) {
        //메인정보 세팅
        $.each(estInfo, function (key, value) {
            if ($('#' + key)[0]) {
                if ($('#' + key).is('[date]')) {
                    $('#' + key).datepicker("setDate", moment(value, 'YYYY-MM-DD').toDate());
                } else {
                    if ($('#' + key).is('[comma]')) {
                        value = addCommaStr(value);
                    }
                    if (key == "coCd") {
                        setByCoCd(value)
                    }
                    $('#' + key).val(value);
                }
            }
        });


        $.each(estInfo.estDetailList, function (idx, obj) {
            if (idx != 0) addRow();
            $addedRow = $("tr[name='detailRow']:last");

            $.each($addedRow.find('[name]'), function (idx, elem) {
                var itemValue = obj[elem.name];
                if (itemValue) {
                    if ($(elem).is("[comma]")) {
                        itemValue = addCommaStr(itemValue);
                    }
                    $(elem).val(itemValue);
                }
            });
        });
        countTot();


        $.each(estInfo.estFileList, function (idx, obj) {
            fileArr.push({
                'fileKey': obj.fileKey,
                'fileName': obj.fileName,
                'fileType': obj.fileType,
                'fileSize': obj.fileSize,
                'file': obj
            });
        });


    }
    
    function opendSalesCdSearch(inputValue) {
    	openSecondModalPopUp("/static/html/cmn/modal/salesCdSearch.html", 600, 420, "Sales Code 검색", {searchValue: inputValue}, function (grid) {
            var row = grid.target.getList("selected")[0];
            console.log(row)
            /* $('#ordrsClntCd_S').val(row.clntCd);
            $('#ordrsClntNm_S').val(row.clntNm);
            gridView.setData(0); */
        });
    }

    // 거래처 검색 함수
    function openSecondClntSearch(id) {
        if (event && event.keyCode === 13) {
            event.preventDefault();  // prevent form from submitting
        }
        openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: id}, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#estClntCd').val(row.clntCd);
            $('#estClntNm').val(row.clntNm);

            var paramObj = {
                "coCd": $('#coCd').val(),
                "clntCd": row.clntCd
            }
            setMngInfo(paramObj);
            $("#estClntNm").focus();
            $("#estClntNm").trigger("click");
        });
    }

    // 담당자 정보 설정 함수
    function setMngInfo(paramObj) {
        postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function (data) {
            if (data.mngInfo) {
                $('#salesEmpId').val(data.mngInfo.salesEmpId);
                $('#salesEmpNm').val(data.mngInfo.salesEmpNm);
            } else {
                $('#salesEmpId').val("");
                $('#salesEmpNm').val("");
            }
        });
    }

    // 사용자 검색 함수
    function openSecondUserSearch(id) {

        if (event && event.keyCode === 13) {
            event.preventDefault();  // prevent form from submitting
        }
        var paramObj = {
            "coCd": "GUN", //$('#coCd').val(),
            "userId": $('#salesEmpId').val(),
            "useYn": "Y",
            "searchValue": id
        };

        openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree) {
            var checkedId = tree.get_checked()[0];
            var checkedNode = tree.get_node(checkedId);
            $("#mngId").val(checkedNode.id);
            $("#mngIdVisible").val(checkedNode.text);
            // $("#salesEmpNm").val(checkedNode.text);
            $("#mngId").focus();
            $("#mngId").trigger("click");
        });
    }


    // 제품 검색 함수
    function openSecondPrdtSearch(elem) {
        $targetRow = $(elem).closest('tr[name="detailRow"]');
        // selpchCd - SELPCH2: 매출
        var paramObj = {
            "coCd": $("#coCd").val(),
            "selpchCd": "SELPCH2",
            "impYn": "N",
            "clntCd": $("#estClntCd").val(),
            "prjctCd": $("#prjctCd").val(),
            "useYn": "Y"
        };

        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            // 값 초기화
            $targetRow.find('input[name]').val("");
            // input 제어
            if (row.prdtStockCd == "Y") {
                $targetRow.find('input[name="prdtSize"]').attr("readonly", false);
                $targetRow.find('input[name="prdtSpec"]').attr("readonly", false);
                $targetRow.find('input[name="estQty"]').attr("readonly", false);
                $targetRow.find('input[name="estWt"]').attr("readonly", false);
            } else {
                $targetRow.find('input[name="prdtSize"]').attr("readonly", true);
                $targetRow.find('input[name="prdtSpec"]').attr("readonly", true);
            }
            $.each(row, function (key, value) {
                if ($targetRow.find('[name="' + key + '"]')[0]) {
                    $targetRow.find('[name="' + key + '"]').val(value);
                }
            });
            $targetRow.find('input[name="estUpr"]').val(row.ordrgUpr);

            countTot();
        });
    }

    // 현장 검색 함수
    function openSecondSiteSearch() {
        var paramObj = {
            "coCd": $('#popForm #coCd').val(),
            "clntCd": $('#popForm #estClntCd').val(),
            "clntNm": $('#popForm #estClntNm').val(),
            "insertYn": "Y",
            "isClntReq": "Y"
        }

        openSecondModal("/static/html/cmn/modal/siteSearch.html", 600, 450, "현장 검색", paramObj, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#prjctCd').val(row.siteCd);
            $('#prjctNm').val(row.siteNm);
        });
    }


    /* 기타함수 */

    // 문자열을 주어진 바이트 길이로 자르는 함수
    function cutStr(str, maxByte) {

        for (b = i = 0; c = str.charCodeAt(i);) {
            b += c >> 7 ? 2 : 1;
            if (b > maxByte)
                break;
            i++;
        }
        return str.substring(0, i);
    }

    // 견적 정보 삽입 함수
    function insertEst() {
        if (validateRequiredFields() && inputValidation($('.popup_area [required]'))) {
            var formData = makeFormData();



            filePostAjax("/user/cr/cr01/insertEst", formData, function (data) {
                modalStack.close();

                if (data.resultCode==200) {
                    alert(data.resultMessage);
                    var newEstData = data.newEst // 문자열을 JSON으로 변환합니다


                    document.getElementById("coCd_S").value = document.getElementById("coCd").value
                    document.getElementById("estNo_S").value = data.param.newEst.estNo;
                    document.getElementById("estDeg_S").value = data.param.newEst.estDeg;
                    document.getElementById("strtDt_S").value="0001-01-01";
                    document.getElementById("endDt_S").value="9999-12-31";
                    gridView.setData(0);
                }
            });
        }
    }

    // 견적 정보 업데이트 함수
    function updateEst() {
        //비고 문자열 길이 필드길이로 byte 자르기
        if (validateRequiredFields() && inputValidation($('.popup_area input[required]'))) {
            var formData = makeFormData();
            filePutAjax("/user/cr/cr01/updateEst", formData, function (data) {
                if (data.resultCode == 0) {
                    alert("수주가 등록된 견적은 업데이트할 수 없습니다.");
                } else if (data.resultCode) {
                    alert(data.resultMessage);
                    document.getElementById("coCd_S").value = document.getElementById("coCd").value
                    document.getElementById("estNo_S").value = data.param.updateEst.estNo;
                    document.getElementById("estDeg_S").value = data.param.updateEst.estDeg;
                    document.getElementById("strtDt_S").value="0001-01-01";
                    document.getElementById("endDt_S").value="9999-12-31";
                    gridView.setData(0);
                    modalStack.close();
                }

            });
        }
    }

    // 폼 데이터 생성 함수
    function makeFormData() {
        var elementsToReformat = $('.popup_area input[comma], #estAmt, #estNegoAmt, #exrate');
        // 금액 콤마 제거
        $.each($('.popup_area input[comma], #estAmt, #estNegoAmt,#exrate'), function (idx, elem) {
            deleteComma(elem);
        });


        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });


        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);

        // 유저아이디 추가
        formData.append("userId", jwt.userId);
        formData.append("fileTrgtKey", paramObj.fileTrgtKey);
        // 첨부파일 추가

        var newFiles = treeModule.getFileArr().filter(function (obj) {
            return obj.fileKey == 0;
        });

        $.each(newFiles, function (idx, obj) {
            formData.append("comonCd_" + idx, obj.nodeId);
            formData.append("files", obj.file);
        });

        formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));


        treeModule.initFileArrays();

        // 상세내역 추가
        var detailArr = [];
        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};
            $.each($(elem).find('[name]'), function (idx, elem) {
                alert(elem);
                formData.append(elem, JSON.elem.value);
            });

        });

        var rowList = grid.getList();
        if (rowList.length == 0) {
            alert("추가할 항목을 선택해주세요_");
            return;
        }
        var detailArr = [];

        $.each(rowList, function (idx, elem) {
            var detailObj = {};
            detailObj["estSeq"] = idx + 1;
            detailObj["estDtlDiv"] = elem.estDtlDiv;
            detailObj["estComm"] = elem.estComm;
            detailObj["estSpec"] = elem.estSpec;
            detailObj["estUnit"] = elem.estUnit;
            detailObj["estQty"] = elem.estQty;
            detailObj["estUpr"] = elem.estUpr;
            detailObj["estRmk"] = elem.estRmk;

            detailArr.push(detailObj);

        });


        formData.append("detailArr", JSON.stringify(detailArr));


        return formData;
    }

    function makeFormDataWithDeg() {
        // 금액 콤마 제거
        $.each($('.popup_area input[comma],#estAmt, #estNegoAmt,#exrate'), function (idx, elem) {
            deleteComma(elem);
        });

        // 날짜 하이픈 제거
        $.each($('.popup_area input[date]'), function (idx, elem) {
            deleteHyphen(elem);
        });

        // 폼데이터 생성
        var formData = new FormData($("#popForm")[0]);

        // 유저아이디 추가
        formData.append("userId", jwt.userId);
        formData.append("fileTrgtKey", paramObj.fileTrgtKey);
        // 첨부파일 추가
        console.log("현재위치" + JSON.stringify(treeModule.getFileArr()));

        var newFiles = treeModule.getFileArrOri();
        $.each(newFiles, function (idx, obj) {
            // Append formData for each file
            formData.append("comonCd_" + idx, obj.comonCd);
            formData.append("filePath_" + idx, obj.filePath);
            formData.append("fileName_" + idx, obj.fileName);
            formData.append("fileKey_" + idx, obj.fileKey);
        });

        var filteredFiles = treeModule.getFileArr().filter(function (obj) {
            return obj.fileKey == 0;
        });

        $.each(filteredFiles, function (idx, obj) {
            var newIdx = newFiles.length + idx;
            formData.append("comonCd_" + newIdx, obj.comonCd);
            formData.append("filePath_" + newIdx, obj.filePath);
            formData.append("fileName_" + newIdx, obj.fileName);
            formData.append("fileKey_" + newIdx, obj.fileKey);
        });
        formData.append("deleteFileArr", JSON.stringify(treeModule.getDeleteFileArr()));


        //  treeModule.initFileArrays();

        // 상세내역 추가
        var detailArr = [];
        $.each($('#detailTable tr[name="detailRow"]'), function (idx, elem) {
            var detailObj = {};
            $.each($(elem).find('[name]'), function (idx, elem) {
                alert(elem);
                formData.append(elem, JSON.elem.value);
            });

        });

        var rowList = grid.getList();
        if (rowList.length == 0) {
            alert("추가할 항목을 선택해주세요_");
            return;
        }
        var detailArr = [];

        $.each(rowList, function (idx, elem) {
            var detailObj = {};
            detailObj["estSeq"] = idx + 1;
            detailObj["estDtlDiv"] = elem.estDtlDiv;
            detailObj["estComm"] = elem.estComm;
            detailObj["estSpec"] = elem.estSpec;
            detailObj["estUnit"] = elem.estUnit;
            detailObj["estQty"] = elem.estQty;
            detailObj["estUpr"] = elem.estUpr;
            detailObj["estRmk"] = elem.estRmk;

            detailArr.push(detailObj);

        });


        formData.append("detailArr", JSON.stringify(detailArr));


        return formData;
    }

    // 체크박스 전체 선택/해제 함수
    function allChk(elem) {
        if ($(elem).prop("checked")) {
            $("[name='detailChkBox']").prop("checked", true);
        } else {
            $("[name='detailChkBox']").prop("checked", false);
        }
    }

    // 판매법인 설정 함수
    function setByCoCd(value) {
        // 판매법인 set
        $('#estCoprt').data("rprc", value);
        $('#estCoprt option:not([value=""])').remove()
        setCommonSelect($('#estCoprt'));
    }


    //견적서 출력 선택 팝업 설정 함수
    function setReportPopup() {
        var paramObj = modalStack.last().paramObj;
        var iChk;
        var rptName;

        openSecondModal("/static/html/user/cr/cr01/SD0303P01.html", 600, 300, "견적서 출력 선택", paramObj, function (rptName, iChk, imgPrt) {
            var arg = "i_est_no#" + paramObj.estNo + "#"
                + "iChk#" + iChk + "#"
                + "imgPrt#" + imgPrt + "#";
            callReport(rptName, arg, 750, 900);
        });


    }


    /* 파일관련함수 */


    /* 리스너 */
    $(document).on("change", "input[name='estQty'], input[name='estWt'], input[name='estAmt'], input[name='expAmt']", function () {

    });

    $(document).on("click", "#fileBtn", function () {
        $("#file").click();
    });
    
    /* document.ready */
    $(document).ready(function () {
    	//$("#coCd").val(jwt.coCd)
		
        try {
            $("#coCd").focus();
            $("#coCd").trigger("click");
            console.error("현재위치 로그::1");
        } catch (error) {
            console.error("현재위치 로그::2" + error); // 콘솔에 에러 메시지를 출력합니다.
        }
        $('.tbody_more_btn').click(function () {
            $(this).toggleClass('on');
            $(this).parent().next('.toggle-div').toggle();
        });
        getMaxEstNumber();
        var inputIds = ['estAmt', 'estNegoAmt', 'exrate', 'cstmMngHp'];

        // 디바운스 함수
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                if (timeout) clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        const alertDebounced = debounce(() => alert("숫자만 입력 가능합니다."), 300);

        inputIds.forEach(function (id) {
            document.getElementById(id).addEventListener('input', function (e) {
                let input = e.target.value;
                let pureNumber = input.replace(/[^0-9,]/g, ''); // 숫자와 콤마가 아닌 문자 제거

                // 한글을 포함하는 경우 경고 메시지 출력하고 함수 종료
                if (/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(input)) {
                    alertDebounced();
                    e.target.value = pureNumber;
                    return;
                }
                if (id === 'cstmMngHp') {
                    if (pureNumber.length > 11) { // 입력값의 길이가 11자리를 초과하면 초과하는 부분 제거
                        pureNumber = pureNumber.slice(0, 11);
                    }

                    let formatted = '';

                    if (pureNumber.length < 4) {
                        return e.target.value = pureNumber;
                    } else if (pureNumber.length < 7) {
                        formatted += pureNumber.substr(0, 3);
                        formatted += '-';
                        formatted += pureNumber.substr(3);
                    } else if (pureNumber.length < 11) {
                        formatted += pureNumber.substr(0, 3);
                        formatted += '-';
                        formatted += pureNumber.substr(3, 3);
                        formatted += '-';
                        formatted += pureNumber.substr(6);
                    } else { // input.length === 11
                        formatted += pureNumber.substr(0, 3);
                        formatted += '-';
                        formatted += pureNumber.substr(3, 4);
                        formatted += '-';
                        formatted += pureNumber.substr(7);
                    }

                    e.target.value = formatted;
                } else {
                    // 숫자와 콤마만 입력되도록 정규식을 사용하여 필터링합니다.
                    e.target.value = e.target.value.replace(/[^0-9,]/g, '');
                    // 세 자리마다 콤마를 삽입합니다.
                    e.target.value = e.target.value.replace(/,/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    // 0으로 시작하는 부분을 제거합니다.
                    e.target.value = e.target.value.replace(/^0+/, '');
                }
            });
        });
        // 공통코드 selectBox set
        setCommonSelect($(".popup_area select[data-kind]"));

        function setCurrentDateToDatePicker(selector) {
            var currentDate = new Date();
            currentDate.setMinutes(currentDate.getMinutes() - currentDate.getTimezoneOffset()); // 시간대를 고려한 날짜 시간 조정
            var year = currentDate.getFullYear();
            var month = currentDate.getMonth() + 1; // 월은 0부터 시작하므로 1을 더합니다.
            var day = currentDate.getDate();

			// 월과 일이 한 자리수라면 앞에 '0'을 추가합니다.
            if (month < 10) month = '0' + month;
            if (day < 10) day = '0' + day;

            var formattedDate = year + '-' + month + '-' + day;
            $(selector).val(formattedDate);
        }

        // 견적일자 datepicker bind
        $('#estDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });

        $('#pblsDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });

        setCurrentDateToDatePicker('#estDt');

        setCurrentDateToDatePicker('#pblsDt');

        /*    var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0
            var yyyy = today.getFullYear();

            today = yyyy + '-' + mm + '-' + dd;
            document.getElementById("estDt").value = today;*/

        $('#estBaseDate').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        $('#issueDate').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        $('#estStdDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        // 낙찰일자 datepicker bind
        $('#winbdDt').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        });
        // 파일 그리드 초기화
        /* 	fileGridView.initView(); */

        $('#ordrsDiv').on('change', function () {
            var selectedValue = $(this).val();
            if (selectedValue === 'normal') {
                $('#orgnSalesCd').prop('required', false);
            } else {
                $('#orgnSalesCd').prop('required', true);
            }
        }).trigger('change');
    });
	/* end (document).ready */
	
    function fetchCurrencyData() {
        /* var paramObj = {"codeKind": "UNITDIV", "useYn": "Y"};
        var paramObj2 = {"codeKind": "ESTDIV", "useYn": "Y"};

        var promise1 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options = codeList.map(function (code) {
                        return {
                            value: code.codeNm,
                            text: code.codeNm
                        };
                    });
                    resolve(options);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });

        var promise2 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj2, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options2 = codeList.map(function (code) {
                        return {
                            value: code.codeNm,
                            text: code.codeNm
                        };
                    });
                    resolve(options2);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        }); */
        
        var paramObjTopLeft = {"coCd": $('#coCd_S_Org').val()};
        var promiseTopLeft = new Promise(function (resolve, reject) {
            postAjax("/user/cr/cr03/selectEstList", paramObjTopLeft, null, function (data) {
                if (data) {
                    resolve(data);
                } else {
                    console.error("topLeftGridData is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        
        var paramObjTopRight = {"coCd": ""};
        var promiseTopRight = new Promise(function (resolve, reject) {
            postAjax("/user/cr/cr03/selectEstList", paramObjTopRight, null, function (data) {
                if (data) {
                    resolve(data);
                } else {
                    console.error("topLeftGridData is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        
        var paramObjBottomLeft = {"coCd": ""};
        var promiseBottomLeft = new Promise(function (resolve, reject) {
            postAjax("/user/cr/cr03/selectEstList", paramObjBottomLeft, null, function (data) {
                if (data) {
                    resolve(data);
                } else {
                    console.error("topLeftGridData is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });
        
        var paramObjBottomRight = {"coCd": ""};
        var promiseBottomRight = new Promise(function (resolve, reject) {
            postAjax("/user/cr/cr03/selectEstList", paramObjBottomRight, null, function (data) {
                if (data) {
                    resolve(data);
                } else {
                    console.error("topLeftGridData is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });

        return Promise.all([promiseTopLeft, promiseTopRight, promiseBottomLeft, promiseBottomRight]);
    }
    /*  end fetchCurrencyData */
    
    fetchCurrencyData().then(function ([promiseTopLeft, promiseTopRight, promiseBottomLeft, promiseBottomRight]) {
		/* var topLeftGrid = new ax5.ui.grid();
    	topLeftGrid.setConfig({
            target: $('[data-ax5grid="top-left-grid"]'),
            columns: [
            	{key: "matrDrwNo", label: "대표도번"},
                {key: "matrPartNo", label: "PART"},
                {key: "unitNo", label: "UNIT"},
                {key: "revNo", label: "REV"},
                {key: "matrCd", label: "품번"},
                {key: "matrNm", label: "품명"},
                {key: "matrSaftQty", label: "수량"},
            ]
        });
    	topLeftGrid.setData({
            list: promiseTopLeft.estList,
            page: {
                currentPage: promiseTopLeft.paginationInfo.currentPageNo,
                pageSize: promiseTopLeft.paginationInfo.pageSize,
                totalElements: promiseTopLeft.estList.length,
                totalPages: promiseTopLeft.paginationInfo.totalPageCount
            }
        }); */
    	setTopLeftTableData(promiseTopLeft)
    });
    
    function setTopLeftTableData(data){
    	var topLeftGrid = new ax5.ui.grid();
    	topLeftGrid.setConfig({
            target: $('[data-ax5grid="top-left-grid"]'),
            columns: [
            	{key: "matrDrwNo", label: "대표도번"},
                {key: "matrPartNo", label: "PART"},
                {key: "unitNo", label: "UNIT"},
                {key: "revNo", label: "REV"},
                {key: "matrCd", label: "품번"},
                {key: "matrNm", label: "품명"},
                {key: "matrSaftQty", label: "수량"},
            ]
        });
    	topLeftGrid.setData({
            list: data.estList,
            page: {
                currentPage: data.paginationInfo.currentPageNo,
                pageSize: data.paginationInfo.pageSize,
                totalElements: data.estList.length,
                totalPages: data.paginationInfo.totalPageCount
            }
        });
    }
        
    function updateTopLeftTableData(){
    	var formData = {
                "coCd": $('#coCd_S_Org').val()
        }
    	console.log("updateTopLeftTableData")
    	console.log(formData)
    	postAjax("/user/cr/cr03/selectEstList", formData, null, function (data) {
    		setTopLeftTableData(data);
    	});
    }
    
    
    
    fetchCurrencyData().then(function ([promiseTopLeft, promiseTopRight, promiseBottomLeft, promiseBottomRight]) {
		var topRightGrid = new ax5.ui.grid();
		topRightGrid.setConfig({
            target: $('[data-ax5grid="top-right-grid"]'),
            columns: [
            	{key: "unitNo", label: "UNIT"},
                {key: "revNo", label: "Rev"},
                {key: "matrCd", label: "품번"},
                {key: "matrNm", label: "품명"},
                {key: "matrMat", label: "소재"},
                {key: "matrMakrNm", label: "MAKER"},
                {key: "matrMno", label: "형번"},
                {key: "matrSpec", label: "규격"},
                {key: "matrSaftQty", label: "수량"}
            ]
        });
		topRightGrid.setData({
            list: promiseTopRight.estList,
            page: {
                currentPage: promiseTopRight.paginationInfo.currentPageNo,
                pageSize: promiseTopRight.paginationInfo.pageSize,
                totalElements: promiseTopRight.estList.length,
                totalPages: promiseTopRight.paginationInfo.totalPageCount
            }
        });
    });
    
    fetchCurrencyData().then(function ([promiseTopLeft, promiseTopRight, promiseBottomLeft, promiseBottomRight]) {
    	var bottomLeftGrid = new ax5.ui.grid();
    	bottomLeftGrid.setConfig({
    		target: $('[data-ax5grid="bottom-left-grid"]'),
            columns: [
            	{key: "salesCd", label: "Sales Code",width: 80,},
                {key: "unitNo", label: "UNIT",width: 80,},
                {key: "partNo", label: "PART",width: 80,},
                {key: "revNo", label: "Rev",width: 80,},
            ]
        });
    	bottomLeftGrid.setData({
            list: promiseBottomLeft.estList,
            page: {
                currentPage: promiseBottomLeft.paginationInfo.currentPageNo,
                pageSize: promiseBottomLeft.paginationInfo.pageSize,
                totalElements: promiseBottomLeft.estList.length,
                totalPages: promiseBottomLeft.paginationInfo.totalPageCount
            }
        });
    });
    
    fetchCurrencyData().then(function ([promiseTopLeft, promiseTopRight, promiseBottomLeft, promiseBottomRight]) {
    	var bottomRightGrid = new ax5.ui.grid();
    	bottomRightGrid.setConfig({
            target: $('[data-ax5grid="bottom-right-grid"]'),
            columns: [
                {key: "upperCd", label: "상위"},
                {key: "partNo", label: "PART"},
                {key: "unitNo", label: "UNIT"},
                {key: "revNo", label: "Rev"},
                {key: "matrCd", label: "품번"},
                {key: "matrNm", label: "품명"},
                {key: "matrMat", label: "소재"},
                {key: "matrMakrNm", label: "MAKER"},
                {key: "matrMno", label: "형번"},
                {key: "matrSpec", label: "규격"},
                {key: "matrSaftQty", label: "수량"},
                {key: "matrBtn", label: "기능버튼"},
            ]
        });
    	bottomRightGrid.setData({
            list: promiseBottomRight.estList,
            page: {
                currentPage: promiseBottomRight.paginationInfo.currentPageNo,
                pageSize: promiseBottomRight.paginationInfo.pageSize,
                totalElements: promiseBottomRight.estList.length,
                totalPages: promiseBottomRight.paginationInfo.totalPageCount
            }
        });
    });
    
    let selectedRowKey;
    let previousSelectedRowKey;
    let selectedPrdtCd;
    let selectedPrdtNm;
	const thirdgrid = new ax5.ui.grid();
    fetchCurrencyData().then(function ([options, options2]) {
    	thirdgrid.setConfig({
            target: $('[data-ax5grid="third-grid"]'),
            columns: [
                {
                    key: "estSeq", label: "번호", width: 40, align: "center", formatter: function () {
                        return this.item.__index + 1;
                    },
                },

                {
                    key: "estDtlDiv", label: "UNIT", width: 80, align: "center", editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options2,


                        }
                    }
                },
                {
                    key: "estComm", label: "Rev", align: "center", width: 80, editor: {
                        type: "text"
                    }
                },
                {key: "estSpec", label: "품번", align: "center", width: 80, editor: {type: "text"}},
                {
                    key: "estUnit", label: "품명", align: "center", width: 80, editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options // 서버에서 가져온 데이터를 사용
                        },
                        event: {
                            'blur': function () {
                                // logic to select the next input field and focus it
                            },
                            'keydown': function (e) {
                                if (e.keyCode == 9) { // tab key
                                    // logic to select the next input field and focus it
                                }
                            }
                        }
                    }
                },
                {key: "estQty", label: "소재", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {key: "estUpr", label: "MAKER", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {
                    key: "estAmt", label: "형번", width: 100, align: "right", formatter: function () {
                        color = '#0000FF';
                        const sumEst = this.item.estQty * this.item.estUpr;
                        return '<div style="color: ' + color + '">' + sumEst.toLocaleString('en-US') + '</div>';
                    }
                },
                {key: "estUpr", label: "규격", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {key: "estUpr", label: "수량", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
            ],

            footSum: [
                [
                    {label: "총합계", align: "center", colspan: 7},
                    {key: "estAmtAll", collector: "sum", formatter: "money", align: "right"},
                ]
            ],
            body: {
                grouping: {
                    by: ["estDtlDiv"],
                    columns: [
                        {label: "소계", colspan: 7, align: "center"},
                        {
                            key: "estAmtMid",
                            collector: function () {
                                let sum = 0;
                                this.list.forEach(function (n) {
                                    if (!n.__grouping) sum += n.estQty * n.estUpr;
                                });
                                return sum;
                                //중간소계
                            },
                            formatter: "money",
                            align: "right",
                        },
                    ],

                },
                onClick: function () {
                    this.self.clearSelect();
                    this.self.select(this.dindex);
                    const subtotalRowsBeforeIndexEs = countSubtotalRowsBeforeIndexEst(this, this.dindex);
                    const realIndex = this.dindex - subtotalRowsBeforeIndexEs;
                    selectedRowKey = realIndex;
                    if (this.column.key == 'estComm') {
                        var _this = this;

                        // 선택된 행의 "estDtlDiv"값을 가져옵니다.
                        let estDtlDivValue = thirdgrid.list[selectedRowKey].estDtlDiv;

                        // 만약 "estDtlDiv"값이 "제작품"이라면 openPrdtSearch 함수를 호출합니다.

                    }

                }
            },
            contextMenu: {
                iconWidth: 20,
                acceleratorWidth: 100,
                itemClickAndClose: false,
                icons: {
                    'arrow': '<i class="fa fa-caret-right"></i>'
                },
                items: [
                    {type: 1, label: "붙여넣기"},
                    {divide: true},
                    {
                        label: "작업선택",
                        items: [
                            {type: 1, label: "줄추가"},
                            {type: 1, label: "내용 삭제"},
                            {type: 2, label: "줄삭제"},
                        ]
                    },
                ],
                popupFilter: function (item, param) {
                    //console.log(item, param);
                    if (param.element) {
                        return true;
                    } else {
                        return item.type == 1;
                    }
                },
                onClick: function (item, param) {
                    console.log(item, param);
                    thisGridRow = param.dindex;
                    thisGridCol = param.colIndex;

                    if (item.label == "붙여넣기") {
                        gridPaste(thisGridRow, thisGridCol);
                    } else if (item.label == "줄추가") {
                        console.log('추가 인덱스 :', param.dindex);
                        //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                        thirdgrid.addRow($.extend({}, thirdgrid.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                        thirdgrid.setValue(param.dindex, 'updcheck', 1);

                    } else if (item.label == "내용 삭제") {
                        console.log('내용삭제 인덱스 :', param.dindex);

                        grid.config.columns.forEach((column) => {
                        	thirdgrid.setValue(param.dindex, column.key, '');
                        	thirdgrid.setValue(param.dindex, 'updcheck', 1);
                            console.log('내용삭제 :', param.dindex, column.key);
                        });

                    } else if (item.label == "줄삭제") {
                        console.log('삭제 인덱스 :', param.dindex);
                        const subtotalRowsBeforeIndexEst = countSubtotalRowsBeforeIndexEst(thirdgrid, param.dindex);
                        const realIndexEst = param.dindex - subtotalRowsBeforeIndexEst;
                        thirdgrid.removeRow(realIndexEst);
                    }


                    thirdgrid.contextMenu.close();
                    //또는 return true;

                }
            }

        });
    	thirdgrid.setColumnSort({
            "estSeq": {orderBy: "asc", seq: 0},
        });
        let isUpdating = false;  // isUpdating 플래그 선언
        thirdgrid.onDataChanged = function () {

            if (this.item.estDtlDiv == undefined || isUpdating) {
                return;
            } else {
                isUpdating = true;  // 업데이트 시작을 표시

                const data = thirdgrid.getList();
                data.forEach((item, index) => {
                    item.estAmtAll = item.estQty * item.estUpr;  // 합계 계산 및 설정
                });
                thirdgrid.setData({
                    list: data,
                    page: {
                        totalElements: data.length
                    }
                });
                isUpdating = false;  // 업데이트 종료를 표시
            }


        };
        let checkDataInterval = null;

        thirdgrid.onLoad = function () {
            checkDataInterval = setInterval(() => {
                const dataEst = thirdgrid.getList();

                // 데이터가 로드되었는지 확인합니다.
                if (dataEst.length > 0) {
                    clearInterval(checkDataInterval);  // 데이터가 로드되었다면 체크를 중단합니다.

                    dataEst.forEach((item, index) => {
                        item.estAmtAll = item.estQty * item.estUpr;  // 합계 계산 및 설정
                    });


                    thirdgrid.setData({
                        list: dataEst,
                        page: {
                            totalElements: dataEst.length
                        }
                    });
                }
            }, 100);  // 1초 간격으로 체크합니다.
        };

    })
    /* end fetchCurrencyData */
    
    const wstgrid = new ax5.ui.grid();
    fetchCurrencyData().then(function ([options, options2]) {
    	wstgrid.setConfig({
            target: $('[data-ax5grid="second-grid"]'),
            columns: [
                {
                    key: "estSeq", label: "번호", width: 40, align: "center", formatter: function () {
                        return this.item.__index + 1;
                    },
                },

                {
                    key: "estDtlDiv", label: "대표도번", width: 80, align: "center", editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options2,


                        }
                    }
                },
                {
                    key: "estComm", label: "PART", align: "center", width: 80, editor: {
                        type: "text"
                    }
                },
                {key: "estSpec", label: "UNIT", align: "center", width: 80, editor: {type: "text"}},
                {
                    key: "estUnit", label: "RE", align: "center", width: 80, editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options // 서버에서 가져온 데이터를 사용
                        },
                        event: {
                            'blur': function () {
                                // logic to select the next input field and focus it
                            },
                            'keydown': function (e) {
                                if (e.keyCode == 9) { // tab key
                                    // logic to select the next input field and focus it
                                }
                            }
                        }
                    }
                },
                {key: "estQty", label: "품번", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {key: "estUpr", label: "품명", align: "right", width: 80, editor: {type: "number"}, formatter: "money"},
                {
                    key: "estAmt", label: "수량", width: 100, align: "right", formatter: function () {
                        color = '#0000FF';
                        const sum = this.item.estQty * this.item.estUpr;
                        return '<div style="color: ' + color + '">' + sum.toLocaleString('en-US') + '</div>';
                    }
                },
               
            ],

            footSum: [
                [
                    {label: "총합계", align: "center", colspan: 7},
                    {key: "estAmtAll", collector: "sum", formatter: "money", align: "right"},
                ]
            ],
            body: {
                grouping: {
                    by: ["estDtlDiv"],
                    columns: [
                        {label: "소계", colspan: 7, align: "center"},
                        {
                            key: "estAmtMid",
                            collector: function () {
                                let sum = 0;
                                this.list.forEach(function (n) {
                                    if (!n.__grouping) sum += n.estQty * n.estUpr;
                                });
                                return sum;
                                //중간소계
                            },
                            formatter: "money",
                            align: "right",
                        },
                    ],

                },
                onClick: function () {
                    this.self.clearSelect();
                    this.self.select(this.dindex);
                    const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(this, this.dindex);
                    const realIndex = this.dindex - subtotalRowsBeforeIndex;
                    selectedRowKey = realIndex;
                    if (this.column.key == 'estComm') {
                        var _this = this;

                        // 선택된 행의 "estDtlDiv"값을 가져옵니다.
                        //let estDtlDivValue = grid.list[selectedRowKey].estDtlDiv;

                        // 만약 "estDtlDiv"값이 "제작품"이라면 openPrdtSearch 함수를 호출합니다.

                    }

                }
            },
            contextMenu: {
                iconWidth: 20,
                acceleratorWidth: 100,
                itemClickAndClose: false,
                icons: {
                    'arrow': '<i class="fa fa-caret-right"></i>'
                },
                items: [
                    {type: 1, label: "붙여넣기"},
                    {divide: true},
                    {
                        label: "작업선택",
                        items: [
                            {type: 1, label: "줄추가"},
                            {type: 1, label: "내용 삭제"},
                            {type: 2, label: "줄삭제"},
                        ]
                    },
                ],
                popupFilter: function (item, param) {
                    //console.log(item, param);
                    if (param.element) {
                        return true;
                    } else {
                        return item.type == 1;
                    }
                },
                onClick: function (item, param) {
                    console.log(item, param);
                    thisGridRow = param.dindex;
                    thisGridCol = param.colIndex;

                    if (item.label == "붙여넣기") {
                        gridPaste(thisGridRow, thisGridCol);
                    } else if (item.label == "줄추가") {
                        console.log('추가 인덱스 :', param.dindex);
                        //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                        wstgrid.addRow($.extend({}, wstgrid.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                        wstgrid.setValue(param.dindex, 'updcheck', 1);

                    } else if (item.label == "내용 삭제") {
                        console.log('내용삭제 인덱스 :', param.dindex);

                        wstgrid.config.columns.forEach((column) => {
                        	wstgrid.setValue(param.dindex, column.key, '');
                        	wstgrid.setValue(param.dindex, 'updcheck', 1);
                            console.log('내용삭제 :', param.dindex, column.key);
                        });

                    } else if (item.label == "줄삭제") {
                        console.log('삭제 인덱스 :', param.dindex);
                        const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(wstgrid, param.dindex);
                        const realIndex = param.dindex - subtotalRowsBeforeIndex;
                        wstgrid.removeRow(realIndex);
                    }


                    wstgrid.contextMenu.close();
                    //또는 return true;

                }
            }

        });
        wstgrid.setColumnSort({
            "estSeq": {orderBy: "asc", seq: 0},
        });
        let isUpdating = false;  // isUpdating 플래그 선언
        wstgrid.onDataChanged = function () {

            if (this.item.estDtlDiv == undefined || isUpdating) {
                return;
            } else {
                isUpdating = true;  // 업데이트 시작을 표시

                const data = wstgrid.getList();
                data.forEach((item, index) => {
                    item.estAmtAll = item.estQty * item.estUpr;  // 합계 계산 및 설정
                });
                wstgrid.setData({
                    list: data,
                    page: {
                        totalElements: data.length
                    }
                });
                isUpdating = false;  // 업데이트 종료를 표시
            }


        };
        let checkDataInterval = null;

        wstgrid.onLoad = function () {
            checkDataInterval = setInterval(() => {
                const data = wstgrid.getList();

                // 데이터가 로드되었는지 확인합니다.
                if (data.length > 0) {
                    clearInterval(checkDataInterval);  // 데이터가 로드되었다면 체크를 중단합니다.

                    data.forEach((item, index) => {
                        item.estAmtAll = item.estQty * item.estUpr;  // 합계 계산 및 설정
                    });


                    wstgrid.setData({
                        list: data,
                        page: {
                            totalElements: data.length
                        }
                    });
                }
            }, 100);  // 1초 간격으로 체크합니다.
        };

    })// end fetchCurrencyData
    
    function countSubtotalRowsBeforeIndex(wstgrid, index) {
        let count = 0;
        for (let i = 0; i < index; i++) {
            if (wstgrid.list[i].__isGrouping) {
                count++;
            }
        }
        return count;
    }
    
    function countSubtotalRowsBeforeIndexEst(grid, index) {
        let count = 0;
        for (let i = 0; i < index; i++) {
            if (grid.list[i].__isGrouping) {
                count++;
            }
        }
        return count;
    }


    function updateRowTotals() {

    }


    function addEstDtlDivData(estDtlDivData) {
        const data = wstgrid.getList();
        wstgrid.setData([...data, ...estDtlDivData]);

        updateRowTotals();
    }

    let currentDivCount = 0;


    $("#addProductButton").on("click", function () {
        var row;
        var newRowData = {
            estDtlDiv: "",
            estComm: "",
            estSpec: "",
            estUnit: "",
            estQty: "",
            estUpr: "",
        };

        // 첫 번째 경우: 선택된 행이 있는 경우
        if (selectedRowKey !== undefined) {
            let row = wstgrid.getList("selected")[0];
            let newRowData = $.extend({}, row, {__index: undefined});
            wstgrid.addRow(newRowData, row.__index + 1);
        }
        // 두 번째 경우: 그리드가 비어 있는 경우
        else if (wstgrid.getList().length === 0) {
        	wstgrid.addRow(newRowData, 0);
        }
        // 세 번째 경우: 그리드에 행은 있지만 선택된 행이 없는 경우
        else {
        	wstgrid.addRow(newRowData, wstgrid.length);
            return;
        }

        const data = wstgrid.getList();
        wstgrid.setData({
            list: data,
            page: {
                totalElements: data.length
            }
        });
    }); // end addProductButton
    
    $("#deleteProductButton").on("click", function () {
        if (selectedRowKey !== undefined) {
        	wstgrid.removeRow(selectedRowKey);
            const data = wstgrid.getList();
            wstgrid.setData({
                list: data,
                page: {
                    totalElements: data.length
                }
            });

            // 선택된 행을 업데이트합니다.
            if (data.length > 0) { // 아직 데이터가 있는지 확인합니다.
                if (selectedRowKey < data.length) { // 선택된 행이 마지막 행이 아니라면 다음 행을 선택합니다.
                	wstgrid.select(selectedRowKey);
                } else { // 선택된 행이 마지막 행이었다면 이전 행을 선택합니다.
                    selectedRowKey = selectedRowKey - 1;
                    wstgrid.select(selectedRowKey);
                }
            } else { // 데이터가 없다면 선택된 행을 초기화합니다.
                selectedRowKey = undefined;
                // 이 경우 삭제 버튼을 비활성화할 수 있습니다.
                // 예: $("#deleteProductButton").prop("disabled", true);
            }
        } else {
            alert("삭제를 위해 선택된 행이 없습니다.");
        }
    });// end deleteProductButton

    function addEstDtlDivWithPreset() {

        const estDtlDivData = [
            {
                estDtlDiv: "제작품",
                estComm: "",
                estSpec: "",
                estUnit: "",
                estQty: "",
                estUpr: "",
            },
            {
                estDtlDiv: "기타경비",
                estComm: "",
                estSpec: "",
                estUnit: "",
                estQty: "",
                estUpr: "",
            },



        ];

        addEstDtlDivData(estDtlDivData);
    }


    var actionType = modalStack.last().paramObj.actionType;
    var paramObj = modalStack.last().paramObj;

    treeModule.initAll('deptTree', 'file-grid-popup', 'FITR01', paramObj);

    function updateButtonVisibility(actionType) {

        var degUpBtn = document.getElementById("degUpBtn");
        var ordrsBtn = document.getElementById("ordrsBtn");



        if (actionType === "U") {
            degUpBtn.style.display = "inline-block";
            ordrsBtn.style.display = "inline-block";
        } else {

            degUpBtn.style.display = "none";
            ordrsBtn.style.display = "none";

        }


    }

    updateButtonVisibility(actionType);

    if (actionType == "C") {
        $(document).ready(function () {


            postAjaxSync("/admin/cm/cm06/selectUserInfo", {"userId": jwt.userId}, null, function (data) {
                $("#mngIdVisible").val(data.userInfo.name);
                $("#mngId").val(data.userInfo.id);
            });
            $("#exrate").val(1);
            $('#estDeg').val(1);
            $('#estAmt').val(0);
            $('#ordrsYn').val('N');
            $('#estNegoAmt').val(0);
        })

        $('#actionBtn').on("click", function () {
            insertEst();
        });
        addEstDtlDivWithPreset();


    } else if (actionType == "U") {


        var parsedDataInfo
        postAjax("/user/cr/cr01/selectEstInfo", paramObj, null, function (data) {
            var parsedData = data;
            Object.keys(parsedData.estInfo).forEach(function (key) {
                var inputField = document.getElementById(key);
                if (inputField) {
                    if (key == 'mngId') {
                        var mngIdField = document.getElementById('mngId');
                        var mngIdVisibleField = document.getElementById('mngIdVisible');
                        mngIdField.value = parsedData.estInfo[key];
                        if (mngIdVisibleField) {
                            var paramObj = {
                                "userId": parsedData.estInfo[key],
                            };
                            postAjaxSync("/admin/cm/cm06/selectUserInfo", paramObj, null, function (data) {
                                mngIdVisibleField.value = data.userInfo.name;
                            });
                        }
                    } else if (key == 'estClntCd') {
                        var estClntNmField = document.getElementById('estClntNm');
                        var estClntCdField = document.getElementById('estClntCd');
                        estClntCdField.value = parsedData.estInfo[key];
                        if (estClntNmField) {

                            var paramObj = {
                                "clntCd": parsedData.estInfo[key],
                            };
                            postAjax("/admin/bm/bm02/selectClntInfo", paramObj, null, function (data) {
                                estClntNmField.value = data.clntInfo.clntNm;
                            });

                        }
                    } else {
                        if (key == 'estAmt' || key == 'estNegoAmt' || key == 'exrate') {
                            // If the key is one of the specified ones, add commas every three digits.
                            var value = parsedData.estInfo[key];
                            if (value != null && value != '') {
                                value = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            }
                            inputField.value = value || '';
                        } else {
                            inputField.value = parsedData.estInfo[key] || '';
                        }

                    }



                }
            });
            var degUpBtn = document.getElementById("degUpBtn");
            var ordrsBtn = document.getElementById("ordrsBtn");

            if (document.getElementById('ordrsYn').value == 'Y') {
                degUpBtn.style.backgroundColor = "gray"; // 버튼 색상을 회색으로 변경
                degUpBtn.disabled = true; // 버튼을 비활성화
                ordrsBtn.style.backgroundColor = "gray"; // 버튼 색상을 회색으로 변경
                ordrsBtn.disabled = true; // 버튼을 비활성화


            } else {
                degUpBtn.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
                degUpBtn.disabled = false; // 버튼을 활성화
                ordrsBtn.style.backgroundColor = ""; // 버튼 색상을 기본값으로 설정
                ordrsBtn.disabled = false; // 버튼을 활성화
            }


            var list = data.estInfo.list;

            wstgrid.setData({
                list: list,
                page: {
                    totalElements: list.length
                }
            });

        });


        $('#actionBtn').on("click", function () {
            updateEst();
        });
        document.getElementById("degUpBtn").addEventListener("click", function () {
            event.preventDefault();
            var estDegInput = document.getElementById("estDeg");
            var currentValue = parseInt(estDegInput.value, 10) || 0;
            var tempEstDtValue = $("#estDt").val();
            var tempIssueDateValue = $("#estDt").val();
            insertEstNew().then((response) => {
                if (response && response.hasOwnProperty('estDeg') && !isNaN(parseInt(response.estDeg))) {
                    alert("차수가 업데이트 되었습니다.");
                    treeModule.initFileArrays();

                    $("#estDt").val(tempEstDtValue);
                    $("#issueDate").val(tempIssueDateValue);
                    document.getElementById("estDeg").value = response.estDeg;
                    loadEstDegrees();
                    document.getElementById("coCd_S").value = document.getElementById("coCd").value
                    document.getElementById("estNo_S").value = $("#estNo").val();
                    document.getElementById("estDeg_S").value = response.estDeg;
                    document.getElementById("strtDt_S").value="0001-01-01";
                    document.getElementById("endDt_S").value="9999-12-31";
                    gridView.setData(0);


                } else {
                    alert("차수가 업데이트 되지않았습니다.");

                }
            });
            // 차수 증가 버튼이 클릭되었음을 표시합니다.

        });
    }


    function insertEstNew() {
        return new Promise((resolve, reject) => {
            if (validateRequiredFields() && inputValidation($('.popup_area [required]'))) {
                var formData = makeFormDataWithDeg();

                filePostAjax("/user/cr/cr01/insertEstDeg", formData, function (data) {
                    if (data.resultCode == 200) {

                        resolve({estDeg: data.param.newEst}); //
                        loadEstDegrees()

                    } else {
                        // 실패한 경우 에러 메시지를 반환합니다.
                        reject("차수가 업데이트 되지 않았습니다."); // Prom

                    }
                });

            }
        });
    }

    function insertOrdrsModal() {
        var paramObj = {
            "actionType": "DC",
            "coCd": $("#coCd").val(),
            "estNo": $("#estNo").val(),
            "ordrsClntCd": $("#estClntCd").val(),
            "ordrsClntNm": $("#estClntNm").val(),
            "clntPjt": $("#estClntNm").val(),
            "mngId": $("#cstmMngNm").val(),
            "exrate": $("#cstmMngHp").val(),
            "clntPjt": $("#clntPjt").val()

        };
        mask = new ax5.ui.mask();
        modal = new ax5.ui.modal();
        modalStack = new ModalStack();

        openModal("/static/html/user/cr/cr02/CR0202P01.html", 1400, 736, "", paramObj);

    }

    document.getElementById("ordrsBtn").addEventListener("click", function () {
        event.preventDefault();
        modalStack.close();
        insertOrdrsModal();
    });

    function addComma(elem) {
        // elem.value는 숫자가 아닐 수 있으므로, NaN이 리턴되는 경우 원래의 값을 사용
        var value = parseFloat(elem.value.replace(/,/g, ''));
        if (isNaN(value)) value = elem.value;

        // 콤마를 추가
        elem.value = value.toLocaleString();
    }

    function validateRequiredFields() {

        const gridIn = wstgrid.getList();

        for (let i = 0; i < gridIn.length; i++) {
            const row = gridIn[i];
            // 필수 입력 필드 검사
            if (!row.estComm || !row.estSpec || !row.estUnit || !row.estQty ||
                !row.estUpr) {
                alert(`견적 상세 필수 입력 필드가 비어 있습니다. (행: ${i + 1})`);
                return false;
            }

        }

        return true;
    }

    function openPrdtSearch(gridIn) {
        var paramObj = {
            "coCd": $('#coCd').val(),
            "prdtCd": $('#prdtId_S').val(),
            "prdtNm": $('#prdtNm_S').val(),
            "useYn": "Y"
        }
        openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid2) {
            var row = grid2.target.getList("selected")[0];
            gridIn.item.estComm = row.prdtNm;
            gridIn.self.repaint();

        });
    }
    
</script>
</html>
