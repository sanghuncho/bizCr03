<!DOCTYPE html>
<html lang="ko">
<style>
    .EST, .file {
        background-color: white;
        visibility: hidden;
    }


    .grid-cell-blue {
        background: #dcf0f8;
    }

    .file, .EST {

        min-height: 800px;
        float: left;
    }
    ul.ul_list.type03-est li {
        width: calc(100% - 6px);
        float: left;
    }

    ul.ul_list.type03-est li:nth-child(odd) {
        clear: left;
    }

    ul.ul_list.type03-est li+li {
    }
    @media only screen and (max-width: 767px) {
        .file, .EST {
            width: 100%;
        }
    }

    @media only screen and (min-width: 768px) {
        .file, .EST {
            width: 50%;
        }

    }
</style>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="/static/fontawesome/css/all.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5grid.css"/>
    <link rel="stylesheet" href="/static/css/ax5/ax5mask.css"/>
    <link rel="stylesheet" href="/static/css/ax5/ax5modal.css"/>
    <link rel="stylesheet" href="/static/css/ax5/ax5toast.css"/>
    <link rel="stylesheet" href="/static/css/jstree/style.min.css"/>
    <link rel="stylesheet" href="/static/css/gnb.css"/>
    <link rel="stylesheet" href="/static/css/main.css"/>
    <!--	<link rel="stylesheet" href="/static/css/sub.css" />-->
    <link rel="stylesheet" href="/static/css/common.css"/>

    <link rel="stylesheet" href="/static/css/sub.css"/>

    <link rel="stylesheet" type="text/css"
          href="https://cdn.rawgit.com/ax5ui/ax5ui-calendar/master/dist/ax5calendar.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/ax5ui/ax5ui-picker/master/dist/ax5picker.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/ax5ui/ax5ui-select/master/dist/ax5select.css">
    <link rel="stylesheet" href="/static/css/ax5/ax5menu.css">

    <script src="/static/js/jquery-latest.min.js"></script>
    <script src="/static/js/jquery.serializeObject.js"></script>
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
    <script src="/static/js/moment/moment-with-locales.js"></script>
    <script src="/static/js/ax5/ax5core.min.js"></script>
    <script src="/static/js/ax5/ax5calendar.min.js"></script>
    <script type="text/javascript"
            src="https://cdn.rawgit.com/ax5ui/ax5ui-picker/master/dist/ax5picker.min.js"></script>
    <script type="text/javascript"
            src="https://cdn.rawgit.com/ax5ui/ax5ui-formatter/master/dist/ax5formatter.min.js"></script>
    <script type="text/javascript"
            src="https://cdn.rawgit.com/ax5ui/ax5ui-select/master/dist/ax5select.min.js"></script>
    <script src="/static/js/ax5/ax5grid.min.js"></script>
    <script src="/static/js/ax5/ax5mask.min.js"></script>
    <script src="/static/js/ax5/ax5modal.min.js"></script>
    <script src="/static/js/ax5/ax5toast.min.js"></script>
    <script src="/static/js/jstree/jstree.min.js"></script>
    <script src="/static/js/ax5/ax5menu.min.js"></script>


    <script type="text/javascript" src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="/static/js/global.js"></script>
    <script src="/static/js/fileTree.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
    <style>

    </style>

</head>

<body>
<div id="head_area"></div>
<div id="top_area"></div>

<div id="main_area">
    <!-- 페이지 상단 -->
    <div class="contents no_bg">
        <ul class="btn_ul">
            <li class="btn_r">
                <a onclick="initSearch();">
                    <button class="bg_gray">초기화</button>
                </a>
                <a onclick="gridView.setData(0);">
                    <button class="bg_gray">검 색</button>
                </a>
            </li>
        </ul>
    </div>
    <!-- 검색 콘텐츠 -->
    <div class="contents search">
        <div class="">
            <!-- 테이블 인풋 3분할 -->
            <table class="table_input type04">
                <tr>
                    <th class="hit">회사</th>
                    <td>
                        <select id="coCd_S" style="width:100%;" data-kind="CO" onchange="gridView.setData(0);"
                                required="required">
                            <option value="">전체</option>
                        </select>
                    </td>
                    <th class="hit">발행일자</th>
                    <td>
                        <div class="date_input">
                            <input type="text" id="strtDt_S" class="input_calendar" autocomplete="off"
                                   required="required" data-search="strtDt_S">
                            <span>~</span>
                            <input type="text" id="endDt_S" class="input_calendar" autocomplete="off"
                                   required="required" data-search="endDt_S">
                        </div>
                    </td>
                    <th class="">고객사</th>


                    <td>
                        <input type="hidden" id="ordrsClntCd_S" name="ordrsClntCd_S">
                        <div class="search_form">
                            <input type="text" id="ordrsClntNm_S" name="ordrsClntNm_S"
                                   >
                            <a onclick="opendClntSearch($('#ordrsClntNm_S').val());">
                                <i class="i_search_w"></i>
                            </a>
                        </div>
                    </td>


                </tr>
                <tr>
                    <th class="">견적서번호</th>
                    <td>
                        <div class="search_form">

                            <input type="text" id="estNo_S" name="estNo_S"
                                   onkeypress="if(event.keyCode == 13) { openEstSearch(this.value); }">
                            <a onclick="openEstSearch($('#estNo_S').val());">
                                <i class="i_search_w"></i>
                            </a>

                        </div>

                    </td>

                    <th class="">견적서차수</th>
                    <td>
                        <select id="estDeg_S" name="estDeg_S" onchange="gridView.setData(0);">

                        </select>
                    </td>
                    <th class="">공사명</th>
                    <td>
                        <div class="search_form">
                            <input type="text" id="estNm_S" name="estNm_S" class="modal-estNm_S">
                        </div>

                    </td>
                </tr>
                <tr>

                </tr>
            </table>
        </div>
    </div>
    <div class="contents no_bg">
        <!-- 콘텐츠 타이틀 -->
        <div class="contents_tit">
            <div>
                <div style="float:right">
                    <a class="btn btn-default btn-sm" onclick="excelDown();"><i class="fas fa-file-excel"></i>
                        엑셀다운로드</a>
                </div>
                <div class="add_btn_small pdl10" style="margin-right:8px;">
                    <a onclick="insertProjectModal('C')" style="height: 30px; line-height: 28px;" authchk>+</a>
                    <a onclick="deleteEst()" style="height: 30px; line-height: 28px;" authchk>-</a>
                </div>

            </div>
            <select class="prae_select" style="height:30px;" onchange="gridView.setData(0);" id="recordCnt">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="9999999">전체</option>
            </select>
            <div class="add_btn_small pdr10">

            </div>
            <input type="hidden" id="recordCnt">
            <input type="hidden" id="basisPriceSeq">
        </div>
    </div>
    <div class="contents">
        <div class="ax5_grid">
            <ul class="ul_list type03-est">
                <li>

                    <div>
                        <div data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 250px; width: 100%"></div>
                    </div>

                </li>
                <li>
                    <div class="table_list_tit">

                    </div>
                    <div>
                        <div data-ax5grid="est-grid" data-ax5grid-config="{}" style="height: 250px; width: 100%;"></div>

                    </div>
                </li>

            </ul>





        </div>
    </div>
</div>
<div data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>

</body>


<script type="text/javascript">


    var authId = null;
    var authRole = null;
    var actionType = null;

    var originalData = [
        // 데이터를 여기에 넣습니다.
    ];


    var gridView = {
        initView: function () {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                height: "250px",
                showRowSelector: true,
                multipleSelect: false,
                sortable: true,
                target: $('[data-ax5grid="first-grid"]'),
                header: {
                    align: "center",
                    selector: false
                },
                body: {

                    onDBLClick: function () {

                        this.self.select(this.dindex);
                        var item = this.item; // 선택된 행의 데이터
                        var coCd = item.coCd; // 선택된 행의 coCd 값
                        var estNo = item.estNo; // 선택된 행의 coCd 값
                        // selectEstInfo 함수 호출
                        var paramObj = {
                            "coCd": coCd,
                            "estNo": estNo
                        };
                        handleClickEvent(this.item);
                        $(".EST ,.file").css("visibility", "visible");

                    },
                    onClick: function () {

                        this.self.select(this.dindex);
                        var item = this.item; // 선택된 행의 데이터
                        var coCd = item.coCd; // 선택된 행의 coCd 값
                        var estNo = item.estNo; // 선택된 행의 coCd 값
                        // selectEstInfo 함수 호출
                        var paramObj = {
                            "coCd": coCd,
                            "estNo": estNo
                        };
                        handleClickMainEvent(this.item);
                        $(".EST ,.file").css("visibility", "visible");

                    },
                },
                page: {
                    navigationItemCount: 9,
                    height: 30,
                    display: true,
                    firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
                    prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
                    nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                    lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
                    onChange: function () {
                        gridView.setData(this.page.selectPage);
                    }
                },
                columns: [
                    {key: "coCd", label: "회사코드", align: "center", width: 80,},
                    {key: "estNo", label: "견적번호", align: "center", width: 80, enableFilter: true},
                    {key: "estDeg", label: "차수", align: "center", width: 80, enableFilter: true},
                    {key: "estClntCd", label: "고객사", align: "center", width: 80},
                    {key: "estClntNm", label: "고객사명", align: "center", width: 80},
                    {key: "estDt", label: "작성일", align: "center", width: 80},
                    {key: "estsDt", label: "견적유효일자FROM", align: "center", width: 120},
                    {key: "esteDt", label: "견적유효일자TO", align: "center", width: 120},
                    {key: "cstmMngNm", label: "고객담당자", align: "center", width: 80},
                    {key: "cstmMngHp", label: "고객담당자 연락처", align: "center", width: 120},
                    {key: "mngId", label: "견적제출자", align: "center", width: 80},
                    {key: "estNm", label: "공사명", align: "center", width: 250},
                    {
                        key: "currCd", label: "통화단위", align: "center", width: 80,
                        formatter: function () {
                            var value = this.value;
                            switch (value) {
                                case "CURR01":
                                    return "WON";
                                case "CURR02":
                                    return "달러";
                                case "CURR03":
                                    return "유로";
                                case "CURR04":
                                    return "엔화";
                                default:
                                    return value;  // unknown value, return as is
                            }
                        }
                    },
                    {key: "exrate", label: "환율", align: "right", width: 80, formatter: "money"},
                    {key: "estAmt", label: "견적금액", align: "right", width: 80, formatter: "money"},
                    {key: "estNegoAmt", label: "견적네고금액", align: "right", width: 120, formatter: "money"},
                    {key: "estExcept", label: "견적제외사항", align: "left", width: 500,},
                    {key: "estStd", label: "견적기준", align: "left", width: 500,},
                    {key: "estDlvrCndt", label: "납품조건", align: "left", width: 80,},
                    {key: "estPmntCndt", label: "결재조건", align: "left", width: 80,},
                    {key: "estDudt", label: "납기", align: "left", width: 80,},
                    {key: "ordrsYn", label: "수주확정여부", align: "center", width: 120,},
                    {key: "ordrsDt", label: "수주확정일자", align: "center", width: 120,},
                    {key: "estRmk", label: "비고", align: "left", width: 80,},
                    /*	{key: "estExcept", label: "견적 제외 사항", align: "left", width: 150},
                        {key: "estStdDt", label: "견적기준일자", align: "center", width: 120},
                        {key: "estDlvrCndt", label: "납 품 조 건", align: "left", width: 180},
                        {key: "estPmntCndt", label: "결 재 조 건", align: "left", width: 180},
                        {key: "estDudt", label: "납 기", align: "center", width: 100},
                        {key: "estRmk", label: "비고", align: "left", width: 150}*/

                ],
                /*		footSum: [
                            [
                                {label: "총합계", 	 align:"center",	  colspan:6},
                                {key: "estQty",     collector: "sum",   formatter:"money",  align: "right"},
                                {key: "estWt",      collector: "sum",   formatter:"money",     align: "right"},
                                {key: "estAmt",     collector: "sum",   formatter:"money",  align: "right"},
                            ]
                        ]

                */
            });
            return this;
        },
        setData: function (_pageNo) {

            var gridViewIn = this.target;
            if (inputValidation($('input[required]'))) {
                var formData = {
                    "coCd": $('#coCd_S').val(),
                    "strtDt": $("#strtDt_S").val().replace(/\-/g, ''),
                    "endDt": $("#endDt_S").val().replace(/\-/g, ''),
                    "prdtDiv": $("#prdtDiv").val(),
                    "taxivcCoprt": $("#taxivcCoprt").val(),
                    "prdtGrp": $("#prdtGrp_S").val(),
                    "searchValue": $("#searchValue_S").val(),
                    "searchName": $("#searchName_S").val(),
                    "winbdYn": $("#winbdYn_S").val(),
                    "pageNo": _pageNo + 1,
                    "recordCnt": $("#recordCnt").val(),
                    "estNo": $("#estNo_S").val(),
                    "estNm": $("#estNm_S").val(),
                    "estDeg": $("#estDeg_S").val(),
                    "clntCd": $("#ordrsClntCd_S").val(),
                    "clntNm": $("#ordrsClntNm_S").val(),

                }
                $("#ordrsClntCd_S").val('');
                postAjax("/user/cr/cr01/selectEstList", formData, null, function (data) {
                    var list = data.estList;

                    // 원래 배열에서의 인덱스를 추적하는 새로운 필드 추가
                    for (let i = 0; i < list.length; i++) {
                        list[i].originalIndex = i;
                    }

                    // "estNo"와 원래 인덱스를 기준으로 정렬하기
                    list.sort(function (a, b) {
                        var numA = parseInt(a.estNo.replace(/\D/g, ''));
                        var numB = parseInt(b.estNo.replace(/\D/g, ''));
                        if (numA != numB) {
                            return numA - numB;
                        } else {
                            return a.originalIndex - b.originalIndex;
                        }
                    });
                    console.log(list)
                    originalData = list;

                    function getClientNameByCode(ordrsClntCd, callback) {
                        var paramObj = {
                            "clntCd": ordrsClntCd
                        };

                        postAjax("/admin/bm/bm02/selectClntInfo", paramObj, null, function (data) {
                            if (data && data.clntInfo) {
                                callback(data.clntInfo.clntNm);
                            } else {
                                callback('');
                            }
                        });
                    }

                    if (list.length === 0) {
                        gridViewIn.setData({
                            list: [],
                            page: {
                                currentPage: _pageNo,
                                pageSize: data.paginationInfo.pageSize,
                                totalElements: list.length,
                                totalPages: data.paginationInfo.totalPageCount
                            }
                        });
                    } else {
                        var completedRequests = 0;
                        for (var i = 0; i < list.length; i++) {
                            (function (index) {
                                getClientNameByCode(list[index].estClntCd, function (clientName) {
                                    list[index].estClntNm = clientName;
                                    completedRequests++;
                                    if (completedRequests === list.length) {
                                        gridViewIn.setData({
                                            list: list,
                                            page: {
                                                currentPage: _pageNo,
                                                pageSize: data.paginationInfo.pageSize,
                                                totalElements: list.length,
                                                totalPages: data.paginationInfo.totalPageCount
                                            }
                                        });
                                    }
                                });
                            })(i);
                        }
                    }


                });


            }
        }
    }


    function fetchCurrencyData() {
        var paramObj = {"codeKind": "UNITDIV", "useYn": "Y"};
        var paramObj2 = {"codeKind": "ESTDIV", "useYn": "Y"};

        var promise1 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options = codeList.map(function (code) {
                        return {
                            value: code.codeNm,
                            text: code.codeNm
                        };
                    });
                    resolve(options);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });

        var promise2 = new Promise(function (resolve, reject) {
            postAjax("/admin/cm/cm05/selectCodeList", paramObj2, null, function (data) {
                if (data && data.codeList) {
                    var codeList = data.codeList;
                    var options2 = codeList.map(function (code) {
                        return {
                            value: code.codeNm,
                            text: code.codeNm
                        };
                    });
                    resolve(options2);
                } else {
                    console.error("codeList is undefined. Check the AJAX response:", data);
                    reject(data);
                }
            });
        });

        return Promise.all([promise1, promise2]);
    }


    let selectedRowKey;
    let previousSelectedRowKey;
    let selectedPrdtCd;
    let selectedPrdtNm;
    const estGrid = new ax5.ui.grid();
    fetchCurrencyData().then(function ([options, options2]) {
        estGrid.setConfig({
            target: $('[data-ax5grid="est-grid"]'),
            header: {
                align: "center",
                selector: false
            },
            columns: [
                {
                    key: "estSeq", label: "번호", width: 40, align: "center", formatter: function () {
                        return this.item.__index + 1;
                    },
                },

                {
                    key: "estDtlDiv", label: "구분", width: 200, align: "center", editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options2,


                        }
                    }
                },
                {
                    key: "estComm", label: "품명", align: "left", width: 360, editor: {
                        type: "text"


                    }
                },
                {key: "estSpec", label: "사양", align: "left", width: 360, editor: {type: "text"}},
                {
                    key: "estUnit", label: "단위", align: "center", width: 50, editor: {
                        type: "select",
                        config: {
                            columnKeys: {
                                optionValue: 'value',
                                optionText: 'text'
                            },
                            options: options // 서버에서 가져온 데이터를 사용
                        },
                        event: {
                            'blur': function () {
                                // logic to select the next input field and focus it
                            },
                            'keydown': function (e) {
                                if (e.keyCode == 9) { // tab key
                                    // logic to select the next input field and focus it
                                }
                            }
                        }
                    }
                },


                {key: "estQty", label: "수량", align: "right", width: 100, editor: {type: "number"}, formatter: "money"},
                {key: "estUpr", label: "단가", align: "right", width: 100, editor: {type: "number"}, formatter: "money"},
                {
                    key: "estAmt", label: "합계", width: 100, align: "right", formatter: function () {
                        color = '#0000FF';
                        const sum = this.item.estQty * this.item.estUpr;
                        return '<div style="color: ' + color + '">' + sum.toLocaleString('en-US') + '</div>';

                    }
                },
                {key: "estRmk", label: "비고", align: "center", width: 50, editor: {type: "text"}},
            ],

            footSum: [
                [
                    {label: "총합계", align: "center", colspan: 7},
                    {key: "estAmtAll", collector: "sum", formatter: "money", align: "right"},
                ]
            ],
            body: {
                grouping: {
                    by: ["estDtlDiv"],
                    columns: [
                        {label: "소계", colspan: 7, align: "center"},
                        {
                            key: "estAmtMid",
                            collector: function () {
                                let sum = 0;
                                this.list.forEach(function (n) {
                                    if (!n.__grouping) sum += n.estQty * n.estUpr;
                                });
                                return sum;
                                //중간소계
                            },
                            formatter: "money",
                            align: "right",
                        },
                    ],

                },
                onClick: function () {
                    this.self.clearSelect();
                    this.self.select(this.dindex);
                    const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(this, this.dindex);
                    const realIndex = this.dindex - subtotalRowsBeforeIndex;
                    selectedRowKey = realIndex;
                    if (this.column.key == 'estComm') {
                        var _this = this;

                        // 선택된 행의 "estDtlDiv"값을 가져옵니다.
                        let estDtlDivValue = estGrid.list[selectedRowKey].estDtlDiv;

                        // 만약 "estDtlDiv"값이 "제작품"이라면 openPrdtSearch 함수를 호출합니다.

                    }

                }
            },
            contextMenu: {
                iconWidth: 20,
                acceleratorWidth: 100,
                itemClickAndClose: false,
                icons: {
                    'arrow': '<i class="fa fa-caret-right"></i>'
                },
                items: [
                    {type: 1, label: "붙여넣기"},
                    {divide: true},
                    {
                        label: "작업선택",
                        items: [
                            {type: 1, label: "줄추가"},
                            {type: 1, label: "내용 삭제"},
                            {type: 2, label: "줄삭제"},
                        ]
                    },
                ],
                popupFilter: function (item, param) {
                    //console.log(item, param);
                    if (param.element) {
                        return true;
                    } else {
                        return item.type == 1;
                    }
                },

                onClick: function (item, param) {
                    console.log(item, param);
                    thisGridRow = param.dindex;
                    thisGridCol = param.colIndex;

                    if (item.label == "붙여넣기") {
                        gridPaste(thisGridRow, thisGridCol);
                    } else if (item.label == "줄추가") {
                        console.log('추가 인덱스 :', param.dindex);
                        //.addRow(추가할 내용, 삽인할위치(생략시 마지막),갯수)
                        estGrid.addRow($.extend({}, estGrid.list[param.dindex], {__index: undefined}), param.dindex + 1,);
                        estGrid.setValue(param.dindex, 'updcheck', 1);

                    } else if (item.label == "내용 삭제") {
                        console.log('내용삭제 인덱스 :', param.dindex);

                        estGrid.config.columns.forEach((column) => {
                            estGrid.setValue(param.dindex, column.key, '');
                            estGrid.setValue(param.dindex, 'updcheck', 1);
                            console.log('내용삭제 :', param.dindex, column.key);
                        });

                    } else if (item.label == "줄삭제") {
                        console.log('삭제 인덱스 :', param.dindex);
                        const subtotalRowsBeforeIndex = countSubtotalRowsBeforeIndex(estGrid, param.dindex);
                        const realIndex = param.dindex - subtotalRowsBeforeIndex;
                        estGrid.removeRow(realIndex);
                    }


                    estGrid.contextMenu.close();
                    //또는 return true;

                }
            }

        });


        estGrid.setColumnSort({
            "estSeq": {orderBy: "asc", seq: 0},
        });
        let isUpdating = false;  // isUpdating 플래그 선언
        estGrid.onDataChanged = function () {

            if (this.item.estDtlDiv == undefined || isUpdating) {
                return;
            } else {
                isUpdating = true;  // 업데이트 시작을 표시

                const data = estGrid.getList();
                data.forEach((item, index) => {
                    item.estAmtAll = item.estQty * item.estUpr;  // 합계 계산 및 설정
                });
                estGrid.setData({
                    list: data,
                    page: {
                        totalElements: data.length
                    }
                });
                isUpdating = false;  // 업데이트 종료를 표시
            }


        };
        let checkDataInterval = null;

        estGrid.onLoad = function () {
            checkDataInterval = setInterval(() => {
                const data = estGrid.getList();

                // 데이터가 로드되었는지 확인합니다.
                if (data.length > 0) {
                    clearInterval(checkDataInterval);  // 데이터가 로드되었다면 체크를 중단합니다.

                    data.forEach((item, index) => {
                        item.estAmtAll = item.estQty * item.estUpr;  // 합계 계산 및 설정
                    });


                    estGrid.setData({
                        list: data,
                        page: {
                            totalElements: data.length
                        }
                    });
                }
            }, 100);
        };

    })


    var excelView = {
        initView: function () {
            this.target = new ax5.ui.grid();
            this.target.setConfig({
                target: $('[data-ax5grid="excel-grid"]'),
                columns: [
                    {key: "coCd", label: "회사코드", align: "center", width: 80,},
                    {key: "estNo", label: "견적번호", align: "center", width: 80, enableFilter: true},
                    {key: "estDeg", label: "차수", align: "center", width: 80, enableFilter: true},
                    {key: "estClntCd", label: "고객사", align: "center", width: 80},
                    {key: "estClntNm", label: "고객사명", align: "center", width: 80},
                    {key: "estDt", label: "작성일", align: "center", width: 80},
                    {key: "estsDt", label: "견적유효일자FROM", align: "center", width: 120},
                    {key: "esteDt", label: "견적유효일자TO", align: "center", width: 120},
                    {key: "cstmMngNm", label: "고객담당자", align: "center", width: 80},
                    {key: "cstmMngHp", label: "고객담당자 연락처", align: "center", width: 120},
                    {key: "mngId", label: "견적제출자", align: "center", width: 80},
                    {key: "estNm", label: "공사명", align: "center", width: 250},
                    {
                        key: "currCd", label: "통화단위", align: "center", width: 80,
                        formatter: function () {
                            var value = this.value;
                            switch (value) {
                                case "CURR01":
                                    return "WON";
                                case "CURR02":
                                    return "달러";
                                case "CURR03":
                                    return "유로";
                                case "CURR04":
                                    return "엔화";
                                default:
                                    return value;  // unknown value, return as is
                            }
                        }
                    },
                    {key: "exrate", label: "환율", align: "right", width: 80, formatter: "money"},
                    {key: "estAmt", label: "견적금액", align: "right", width: 80, formatter: "money"},
                    {key: "estNegoAmt", label: "견적네고금액", align: "right", width: 120, formatter: "money"},
                    {key: "estExcept", label: "견적제외사항", align: "center", width: 500,},
                    {key: "estStd", label: "견적기준", align: "center", width: 500,},
                    {key: "estDlvrCndt", label: "납품조건", align: "center", width: 80,},
                    {key: "estPmntCndt", label: "결재조건", align: "center", width: 80,},
                    {key: "estDudt", label: "납기", align: "center", width: 80,},
                    {key: "ordrsYn", label: "수주확정여부", align: "center", width: 120,},
                    {key: "ordrsDt", label: "수주확정일자", align: "center", width: 120,},
                    {key: "estRmk", label: "비고", align: "center", width: 80,},
                ],

            });
            return this;
        }
    }
    //화면로드시
    $(document).ready(function () {
        excelView.initView();
        $("#coCd_S").focus();
        mainDefaultLoad("영업관리", "견적서 관리");
        setCommonSelect($("#main_area select[data-kind]"));
        $("#coCd_S").val(jwt.coCd);
        setByCoCd($("#coCd_S").val());

        loadEstDegrees();
        $('.modal-estNm_S,.estNo_S').keypress(function (event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if (keycode == '13') { // '13' is the keycode for the Enter key

                gridView.setData(0);
            }
        });

        // 시작일 (현재날짜의 월 첫일)
        $('#strtDt_S').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        })
            .datepicker("setDate", moment(new Date()).startOf("month").toDate())
            .on("changeDate", function () {
                if ($('#strtDt_S').val() > $('#endDt_S').val()) {
                    alert("날짜를 확인해주세요");
                    $('#strtDt_S').datepicker("setDate", new Date($('#endDt_S').val()));
                }
            });

        // 종료일 (현재날짜의 월 말일)
        $('#endDt_S').datepicker({
            format: "yyyy-mm-dd",
            language: "ko",
            autoclose: true
        })
            .datepicker("setDate", moment(new Date()).endOf("month").toDate())
            .on("changeDate", function () {
                if ($('#strtDt_S').val() > $('#endDt_S').val()) {
                    alert("날짜를 확인해주세요");
                    $('#endDt_S').datepicker("setDate", new Date($('#strtDt_S').val()));
                }
            });

        gridView.initView().setData(0);
        $("#ordrsClntNm_S").keypress(function(event){
            if(event.keyCode == 13){  // Enter 키의 키 코드는 13입니다.
                gridView.setData(0);
                event.preventDefault();  // 폼 제출 등의 기본 동작을 방지합니다.
                }
        });
        $('.input_calendar').on('change', function () {
            gridView.setData(0);
        });

    })


    function fetchDataAndUpdatePage(requestData) {
        postAjaxSync("/user/cr/cr01/selectEstInfo", requestData, null, function (response) {
            const estInfo = response.estInfo;
            const list = estInfo.list;


            document.getElementById("company-name").innerText = estInfo.coCd;
            document.getElementById("ceo-name").innerText = estInfo.estNo;
            document.getElementById("customer-manager").innerText = estInfo.estClntCd;
            document.getElementById("address").innerText = estInfo.estDt;
            document.getElementById("phone-number").innerText = estInfo.estsDt;
            document.getElementById("fax-number").innerText = estInfo.esteDt;
            document.getElementById("email").innerText = estInfo.cstmMngNm;
            document.getElementById("writing-date").innerText = estInfo.cstmMngHp;
            document.getElementById("submitter").innerText = estInfo.estNm;
            document.getElementById("validity-period").innerText = estInfo.estAmt;
            document.getElementById("project-name").innerText = estInfo.estExcept;
            $(".append-table").remove();
            const tableHtml = createDynamicTable(list);

            $(".EST").append(tableHtml);

        });
    }


    /* function setSelectCombo(){
        var paramObj = {
            "userId" : jwt.userId,
            "wh" : "WH"
        };

        postAjax("/user/sm/sm02/selectCmnCodeList", paramObj, null,  function(data){

            var whHtml = '<option value="" selected>전체선택</option>';
            var cmnCodeInfo = data.cmnCodeInfo;

            $.each(cmnCodeInfo, function(index, item){
                if(item.codeKind == 'WH'){
                    whHtml += '<option value='+item.codeId+'>';
                    whHtml += item.codeNm;
                    whHtml += '</option>';
                }

                document.getElementById("searchOutCoCd").innerHTML = whHtml;
                document.getElementById("searchInCoCd").innerHTML = whHtml;
            });
        });
    } */


    // 거래처 검색 함수
    function opendClntSearch(inputValue) {
        openModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {searchValue: inputValue}, function (grid) {
            var row = grid.target.getList("selected")[0];
            $('#ordrsClntCd_S').val(row.clntCd);
            $('#ordrsClntNm_S').val(row.clntNm);
            gridView.setData(0);
        });
    }

    function opendClntSearchEnter(searchValue) {

        postAjax("/static/html/cmn/modal/clntSearch.html", {CODE_ETC: searchValue}, null, function (data) {
            alert(JSON.stringify(data));
            $("#ordrsClntCd_S").val()
            gridView.setData(0);

        })
    };


    function openEstSearch(inputValue) {
        openModal("/static/html/cmn/modal/estSearch.html", 600, 420, "견적서 검색", {searchValue: inputValue}, function (grid) {
            var row = grid.target.getList("selected")[0];


            $('#estNo_S').val(row.estNo);
            $('#estDeg_S').val(row.estDeg);
            gridView.setData(0);


        });
    }

    function insertUpdateEst(type, estNo) {
        var paramObj = {"actionType": type};
        if (type == "U") {
            paramObj.estNo = estNo
        }
// 		var paramObj = {i_est_no : row.estNo}
// 		actionType = type;
        openModal("/static/html/user/cr/cr01/CR0102P01.html", 1300, 780, "", paramObj);
    }

    async function handleClickEvent(item) {
        updateProjectModal(item)

    }

    function handleClickMainEvent(item) {
        updateDetailGrid(item)

    }


    function updateProjectModal(item) {
        var paramObj = {
            "actionType": "U",
            "coCd": item.coCd,
            "estNo": item.estNo,
            "estDeg": item.estDeg,
            "fileTrgtKey": item.fileTrgtKey
        };
        openModal("/static/html/user/cr/cr01/CR0102P01.html", 1400, 736, "", paramObj);
        treeModule.initFileArrays();
    }

    function updateDetailGrid(item) {
        var paramObj = {
            "actionType": "U",
            "coCd": item.coCd,
            "estNo": item.estNo,
            "estDeg": item.estDeg,
            "fileTrgtKey": item.fileTrgtKey
        };
        postAjax("/user/cr/cr01/selectEstInfo", paramObj, null, function (data) {
            var parsedData = data;
            Object.keys(parsedData.estInfo).forEach(function (key) {
                var inputField = document.getElementById(key);
                if (inputField) {
                    if (key == 'mngId') {
                        var mngIdField = document.getElementById('mngId');
                        var mngIdVisibleField = document.getElementById('mngIdVisible');
                        mngIdField.value = parsedData.estInfo[key];
                        if (mngIdVisibleField) {
                            var paramObj = {
                                "userId": parsedData.estInfo[key],
                            };
                            postAjaxSync("/admin/cm/cm06/selectUserInfo", paramObj, null, function (data) {
                                mngIdVisibleField.value = data.userInfo.name;
                            });
                        }
                    } else if (key == 'estClntCd') {
                        var estClntNmField = document.getElementById('estClntNm');
                        var estClntCdField = document.getElementById('estClntCd');
                        estClntCdField.value = parsedData.estInfo[key];
                        if (estClntNmField) {

                            var paramObj = {
                                "clntCd": parsedData.estInfo[key],
                            };
                            postAjax("/admin/bm/bm02/selectClntInfo", paramObj, null, function (data) {
                                estClntNmField.value = data.clntInfo.clntNm;
                            });

                        }
                    } else {
                        if (key == 'estAmt' || key == 'estNegoAmt' || key == 'exrate') {
                            // If the key is one of the specified ones, add commas every three digits.
                            var value = parsedData.estInfo[key];
                            if (value != null && value != '') {
                                value = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            }
                            inputField.value = value || '';
                        } else {
                            inputField.value = parsedData.estInfo[key] || '';
                        }

                    }


                }
            });
            var degUpBtn = document.getElementById("degUpBtn");
            var ordrsBtn = document.getElementById("ordrsBtn");


            var list = data.estInfo.list;

            estGrid.setData({
                list: list,
                page: {
                    totalElements: list.length
                }
            });

        });

    }

    function initSearch() {
        // 모든 텍스트 필드 값을 초기화
        $(".table_input.type04 input[type='text']").val("");

        // 회사 선택 상자 값 설정
        $("#coCd_S").val(jwt.coCd);

        // 날짜 필드 값 설정
        $("#strtDt_S").val(lastWeek());
        $("#endDt_S").val(dateToStr(new Date()));

        // '견적서차수' 선택 상자 초기화
        $("#estDeg_S option").eq(0).prop("selected", true);

        // 그리드 뷰 초기화
        gridView.initView().setData(0);
    }

    function deleteEst() {
        var row = gridView.target.getList("selected")[0];
        var formData = {
            "coCd": row.coCd,
            "estNo": row.estNo,
            "estDeg": row.estDeg,
            "fileTrgtKey": row.fileTrgtKey,
        }
        if (confirm("삭제하시겠습니까?")) {
            deleteAjax("/user/cr/cr01/deleteEst", formData, null, function (data) {

                if (data.resultCode) {
                    alert(data.resultMessage);
                    gridView.setData(0);
                    loadEstDegrees()


                } else {
                    alert("수주가 등록된 견적은 삭제할 수 없습니다.");

                }


            });
        }
    }

    function setReportMain() {
        var row = gridView.target.getList("selected")[0];
        var iChk;
        var rptName;
        if (row == undefined) {
            alert("출력할 견적자료를 선택하세요!");
            return;
        }
// 		if(typ == 1) {
// 			var fileName = "SD0301R01.jrf";
// 		} else {
// 			var fileName = "SD0301R02.jrf";
// 		}

        var paramObj = {
            "iChk": iChk
        }
        openSecondModal("/static/html/user/cr/cr01/CR0303P01.html", 600, 300, "견적서 출력 선택", paramObj, function (rptName, iChk, imgPrt) {
            var arg = "i_est_no#" + row.estNo + "#"
                + "iChk#" + iChk + "#"
                + "imgPrt#" + imgPrt + "#";
            callReport(rptName, arg, 750, 900);
        });
    }

    // 판매법인 set
    function setByCoCd(value) {
        $('#main_area #taxivcCoprt').data("rprc", value);
        $('#main_area #taxivcCoprt option:not([value=""])').remove()
        setCommonSelect($('#main_area #taxivcCoprt'));
    }

    /* 디테일 정보  */
    function createDynamicTable(data) {

        let tableHtml = `
	    <table class="append-table">
	      <tr>
	        <th>NO.</th>
	        <th>품 명</th>
	        <th>사 양</th>
	        <th>단 위</th>
	        <th>수 량</th>
	        <th>단 가</th>
	        <th>합 계</th>
	        <th>비 고</th>
	      </tr>`;

        data.forEach((row, index) => {
            tableHtml += `
	      <tr>
	        <td>${index + 1}</td>
	        <td>${row.estComm || "0"}</td>
	        <td>${row.estSpec || ""}</td>
	        <td>${row.estUnit || ""}</td>
	        <td>${row.estQty || "0"}</td>
	        <td>${row.estUpr || ""}</td>
	        <td>${row.estAmt || "0"}</td>
	        <td>${row.estRmk || ""}</td>
	      </tr>`;
        });

        tableHtml += `</table>`;
        return tableHtml;
    }


    function insertProjectModal(type) {
        var paramObj = {"actionType": type};
        openModal("/static/html/user/cr/cr01/CR0102P01.html", 1400, 736, "", paramObj);
        treeModule.initFileArrays();
    }

    function getCodeKind() {
        var codeKind = "BKAC";
        /*		if($('#codeDiv').val()){
                    if($('#largeDiv').val()){
                        if($('#midDiv').val()){
                            codeKind = $('#midDiv').val();
                        }else{
                            codeKind = $('#largeDiv').val();
                        }
                    }else{
                        codeKind = $('#codeDiv').val();
                    }
                }
        */
        return codeKind;
    }

    function excelDown() {
        var targetObj = this.target;
        var paramObj = {"pageNo": 1, "recordCnt": 99999};

        // 분류값 set
        paramObj.codeKind = getCodeKind();

        // 사용여부 set
        paramObj.useYn = $('#useType').val();

        // 검색구분 set
        paramObj.searchType = $('#searchType').val();

        // 검색어 set
        paramObj.searchValue = $('#searchValue').val();

        postAjax("/user/cr/cr01/selectEstList", paramObj, null, function (data) {

            excelView.target.setData({
                list: data.estList,
                page: {
                    totalElements: data.paginationInfo.totalRecordCount
                }
            });
            var todayDate = new Date().format('yyyyMMddHHmmss');
            excelView.target.exportExcel("견적목록_" + todayDate + ".xls");
        });
    }

    function loadEstDegrees() {
        postAjaxSync("/user/cr/cr01/selectMaxEstDeg", {}, null, function (data) {
            if (data && data.maxEstDeg) {
                console.log('Received data:', data); // 서버에서 받아온 데이터 로깅
                var maxEstDeg = parseInt(data.maxEstDeg); // maxEstDeg를 숫자로 변환
                if (isNaN(maxEstDeg)) { // 숫자로 변환할 수 없는 경우 로깅
                    console.error('Invalid maxEstDeg:', data.maxEstDeg);
                    return;
                }
                var selectElem = document.getElementById("estDeg_S");
                selectElem.innerHTML = ""; // 기존 옵션 초기화

                // '전체' 옵션을 생성하고 추가
                var allOptionElem = document.createElement("option");
                allOptionElem.value = "";
                allOptionElem.text = "전체";
                selectElem.add(allOptionElem);

                for (var i = 1; i <= maxEstDeg; i++) {
                    var optionElem = document.createElement("option");
                    optionElem.value = i;
                    optionElem.text = i;
                    selectElem.add(optionElem);
                }
                console.log('Updated select element:', selectElem); // 업데이트된 selectElem 로깅
            } else {
                console.error('No data or maxEstDeg:', data); // 데이터 또는 maxEstDeg가 없는 경우 로깅
            }
        });
    }
</script>
</html>
